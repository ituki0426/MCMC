---
marp: true
---
<!--
headingDivider: 1
-->

# 6.3.MH法

この章では、ギブスサンプリングやHMC法のような便利なアルゴリズムの基礎となっているメトロポリス・ヘイスティング法（MH法）を紹介します。

メトロポリス法では、


$$
\min(1, e^{S(x) - S(x')})
$$
の確率で提案

$$
x' = x + \Delta x
$$
を受理する

---

したがって、遷移確率T({x}→{x'})は
$$
T(x \to x') = (\Delta x = x' - x \text{ となる確率}) \times \min \left( 1, \frac{e^{-S(x')}}{e^{-S(x)}} \right)
$$

これに加えて、

$$
(\Delta x = x' - x \text{ となる確率}) = (\Delta x = x - x' \text{ となる確率})
$$

も仮定することで、詳細つり合いが示せた。

二番目の条件が成り立たない場合はどうしたらよい？

例えば、

$$
(\Delta x > 0 \text{ となる確率}) = (\Delta x < 0 \text{ となる確率}) \times 2
$$

だったら？

この場合、提案の受理確率を変更すれば詳細つり合いを回復させられます。

---

今の場合例えば...

$\delta x > 0$ の時だけ、半分にしてやれば良い

MH法はもう少しうまい工夫をする。

$\delta x = x' - x$ となる確率をxとx'に依存するf(x→x')という関数とする。

ただし、 $f(x→x')>0$ であれば $f(x'→x)>0$ も成り立つものと仮定する

---

この時、たとえ

$$
f(x→x')\neq f(x'→x)
$$

だったとしても、x→x'という更新が受理される確率を

$$
\min \left( 1, \frac{e^{-S(x')} f(x' \to x)}{e^{-S(x)} f(x \to x')} \right)
$$

と変更すれば詳細つり合い条件

$$
e^{-S(x)} * T(x \rightarrow x') = e^{-S(x)} * T(x' \rightarrow x)
$$
が満たされる。

# 確認する


## 1. $f(x \to x') = f(x' \to x) = 0$ 

$f(x \to x') = f(x' \to x) = 0$ であれば遷移確率は $T(x \to x') = T(x' \to x) = 0$ なので，
$e^{-S(x)} \cdot T(x \to x') = e^{-S(x')} \cdot T(x' \to x)$ は自明です。

そこで以下では $f(x \to x') > 0$, $f(x' \to x) > 0$ の場合を考えることにしましょう。

---

## 2. $f(x \to x') > 0$, $f(x' \to x) > 0$
遷移確率は
$$
T(x \to x') = f(x \to x') \times \min \left( 1, \frac{e^{-S(x')} f(x' \to x)}{e^{-S(x)} f(x \to x')} \right),
\tag{6.48}
$$

$$
T(x' \to x) = f(x' \to x) \times \min \left( 1, \frac{e^{-S(x)} f(x \to x')}{e^{-S(x')} f(x' \to x)} \right),
\tag{6.49}
$$

です。

---

## 2.1 $e^{-S(x')} f(x' \to x) \geq e^{-S(x)} f(x \to x')$ の場合

$e^{-S(x')} f(x' \to x) \geq e^{-S(x)} f(x \to x')$ の時は，

$$
e^{-S(x)} T(x \to x') = e^{-S(x)} f(x \to x') \times 1, \tag{6.50}
$$

$$
e^{-S(x')} T(x' \to x) = e^{-S(x')} f(x' \to x) \times \frac{e^{-S(x)} f(x \to x')}{e^{-S(x')} f(x' \to x)}, \tag{6.51}
$$

なので，

$$
e^{-S(x)} T(x \to x') = e^{-S(x')} T(x' \to x) = e^{-S(x)} f(x \to x') \tag{6.52}
$$

---

## 2.2 $e^{-S(x')} f(x' \to x) \geq e^{-S(x)} f(x \to x')$ の場合

$$
e^{-S(x)} T(x \to x') = e^{-S(x)} f(x \to x') \times 1, \tag{6.50}
$$

$$
e^{-S(x')} T(x' \to x) = e^{-S(x')} f(x' \to x) \times \frac{e^{-S(x)} f(x \to x')}{e^{-S(x')} f(x' \to x)} \tag{6.51}
$$

なので、

$$
e^{-S(x)} T(x \to x') = e^{-S(x')} T(x' \to x) = e^{-S(x)} f(x \to x') \tag{6.52}
$$

であり、詳細つり合いが成り立っている。

---

## 2.3 $e^{-S(x')} f(x' \to x) < e^{-S(x)} f(x \to x')$ の場合


ｘtoｘ’を入れ替えて同じ計算をすれば詳細つり合いが示せる。

---

一変数の例を示したが、多変数の場合も同じ。

この方法を**メトロポリス・ヘイスティング法**という

f({x}→{x'})=f({x'}→{x})の場合は普通のメトロポリス法です。

# メトロポリス・ヘイスティング法

1. 更新の提案確率 $f(\{x\} \to \{x'\})$ が与えられているとする。ただし、$f(\{x\} \to \{x'\}) > 0$ の時には $f(\{x'\} \to \{x\}) > 0$ であるとする。この $f$ を用いて、$\{x^{(k)}\}$ から $\{x^{(k+1)}\}$ の候補 $\{x'\}$ を提案する。

2. メトロポリステスト：0 と 1 の間の一様乱数 $r$ を生成。

$$
r < \frac{e^{-S(x')} f(x' \to x)}{e^{-S(x)} f(x \to x')}
\tag{6.53}
$$

ならば提案を受理して $\{x^{(k+1)}\} = \{x'\}$ と更新。それ以外は棄却して $\{x^{(k+1)}\} = \{x^{(k)}\}$ とする。


# 6.3.1.メトロポリス法と比較したときの利点

メトロポリス法では更新の受理確率が

$$
\min(1, e^{S(x) - S(x')}) = \min \left( 1, \frac{e^{-S(\{x'\})}}{e^{-S(\{x\})}} \right)
$$

でしたが、メトロポリス・ヘイスティン法では

$$

\min \left( 1, \frac{e^{-S(x')} f(x' \to x)}{e^{-S(x)} f(x \to x')} \right)
$$


です。

---

そのため、更新の提案確率

$$
f({x}→{x'})
$$

をうまく選ぶことで受理確率を1に近づけることができる場合があります。

もちろん、そのようなf({x}→{x'})を見つけるのは一般に難しい問題です。

すぐ後で説明するギブスサンプリングやHMC法はf({x}→{x'})を非常にうまく選んだメトロポリス・ヘイスティング法と考えることもできる。

7.2.4.節で紹介するWolffアルゴリズムも同様です。

# 6.3.2.ギブスサンプリングがメトロポリス・ヘイスティング法の例になっていること

ギブスサンプリングでは、$y, z, \cdots$ を固定して $x$ を相対的な重み $e^{-S(x; y, z, \cdots)}$ で更新しました。したがって、

$$
\frac{f(x' \to x)}{f(x \to x')} = \frac{e^{-S(x; y, z, \cdots)}}{e^{-S(x'; y, z, \cdots)}} \tag{6.56}
$$

となっており，

$$
\frac{e^{-S(x'; y, z, \cdots)} f(x' \to x)}{e^{-S(x; y, z, \cdots)} f(x \to x')} = 1 \tag{6.57}
$$

となります。つまり、更新の提案確率をうまく選んで受理確率を100％にしたのがギブスサンプリングです。

# 6.3.3 HMC法もMH法の例になっていること

HMC法では、運動量pも込みで(x,p)→(x',p')という時間発展を考えたので、x→x'
という更新の提案確率は

$$
f(x \to x') \propto e^{-\frac{p^2}{2}}
$$

逆向きの場合は

$$
f(x' \to x) \propto e^{-\frac{p^2}{2}}
$$

したがって、

$$
\frac{e^{-S(x')} f(x' \to x)}{e^{-S(x)} f(x \to x')} = \frac{e^{-H(x', p')}}{e^{-H(x, p)}} \tag{6.58}
$$

---

これはHMC法のメトロポリステストに使われる

$$
e^{H_{\text{init}} - H_{\text{fin}}}
$$

に他ならない

HMC法も、更新の提案の仕方がうまく工夫されたMH法と思える